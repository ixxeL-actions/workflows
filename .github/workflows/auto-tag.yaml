---
name: Automate tag
on:
  workflow_call:
    secrets:
      git-token:
        required: true
    inputs:
      workingdir:
        required: false
        default: "./"
        type: string
      runs-on:
        description: OS to run jobs on
        required: false
        default: ubuntu-latest
        type: string
      ci-image:
        description: docker image to run pipeline on
        required: false
        default: ixxel/toolbox:base-latest
        type: string
      workflows-directory:
        description: directory in which to find workflows
        required: false
        default: "./.github/workflows/*.yaml"
        type: string
      actions-source:
        description: origin of actions
        required: false
        default: ixxeL-actions
        type: string
      new-ref:
        required: true
        type: string
      git-workdir:
        required: false
        default: .
        type: string
      push-option:
        required: false
        default: ci.skip
        type: string
      update-base-tag:
        required: false
        default: true
        type: boolean
      release-verify-tag:
        required: false
        default: false
        type: boolean
      release-target-branch:
        required: false
        default: ${{ github.ref_name }}
        type: string
jobs:
  auto-tag:
    name: auto-tag
    timeout-minutes: 3
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ${{ inputs.ci-image }}
    steps:
      - name: Clone code
        uses: actions/checkout@v3
        with:
          fetch-depth: '0'
          token: ${{ secrets.git-token }}
      - name: substitute-ref
        id: substitute-ref
        uses: ixxeL-actions/workflows/.github/actions/change-action-ref@v1.0.1
        with:
          workflows-directory: ${{ inputs.workflows-directory }}
          actions-source: ${{ inputs.actions-source }}
          new-ref: ${{ inputs.new-ref }}
      - name: Git config
        id: git-config
        uses: ixxeL-actions/workflows/.github/actions/git-config@v1.0.1
        with:
          git-workdir: ${{ inputs.workingdir }}
      # - name: Update changelog
      #   id: changelog
      #   uses: ixxeL-actions/workflows/.github/actions/generate-changelog@main
      #   with:
      #     workingdir: ${{ inputs.workingdir }}
      #     release-name: ${{ inputs.new-ref }}
      - name: Git push
        id: git-push
        uses: ixxeL-actions/workflows/.github/actions/git-push@v1.0.1
        with:
          git-msg: ':package: CI release version ${{ inputs.new-ref }} from user ${GITHUB_ACTOR} [skip ci]'
          git-workdir: ${{ inputs.workingdir }}
          git-staging-dir: ${{ inputs.workingdir }}
          push-option: ${{ inputs.push-option }}
      # - name: Git tag
      #   id: git-tag
      #   uses: ixxeL-actions/workflows/.github/actions/git-tag@main
      #   with:
      #     tag-msg: ':package: CI release version ${{ inputs.new-ref }} from user ${GITHUB_ACTOR} [skip ci]'
      #     tag-value: ${{ inputs.new-ref }}
      #     git-workdir: ${{ inputs.workingdir }}
      #     push-option: ${{ inputs.push-option }}
      - name: GH Release
        id: gh-release
        uses: ixxeL-actions/workflows/.github/actions/gh-release@v1.0.1
        with:
          tag: ${{ inputs.new-ref }}
          verify-tag: ${{ inputs.release-verify-tag }}
          target-branch: ${{ inputs.release-target-branch }}
        env:
          GH_TOKEN: ${{ github.token }}
      - name: Extract Major
        id: extract-major
        run: |
          if [[ "${{ inputs.new-ref }}" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            BASE_VERSION=$(echo "${{ inputs.new-ref }}" | grep -Eo "^v?[0-9]{1}")
            echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_OUTPUT
          fi
      - name: Git update base tag
        id: git-tag
        if: inputs.update-base-tag == 'true'
        uses: ixxeL-actions/workflows/.github/actions/git-tag@v1.0.1
        with:
          tag-msg: 'update tag semver [skip ci]'
          tag-value: ${{ steps.extract-major.outputs.BASE_VERSION }}
          git-workdir: ${{ inputs.workingdir }}
          push-option: ${{ inputs.push-option }}
